# 数据完整性检查脚本

## 说明

`check_and_refetch.py` 用于检查每一天的涨停、跌停、炸板股池数据，如果其中任何一项为零或文件损坏/缺失，会自动标记为需要重新获取。

## 使用方法

### 1. 检查所有数据（推荐）

```bash
python check_and_refetch.py
```

脚本会：
- 扫描 `data/history/` 目录下所有日期的数据文件
- 检查每个日期的三个股池（涨停、跌停、炸板）
- 显示每个日期的检查结果
- 如果发现不完整的数据，询问是否重新获取
- 可以选择自动重新获取不完整的数据

### 2. 仅检查不重取（Dry-run模式）

```bash
python check_and_refetch.py --check-only
```

只进行检查，自动跳过重取步骤，适合预览哪些日期有问题。

### 3. 检查指定日期

```bash
python check_and_refetch.py --date 2025-08-25
```

检查单个日期的数据完整性，并给出是否重取的建议。

### 4. 使用自定义数据目录

```bash
python check_and_refetch.py --dir data/backup_history
```

指定不同的数据目录进行检查。

## 检查标准

脚本会检查以下问题：

1. **涨停股池为0** - `data/history/limit_up/{date}.json` 中的 count 为0
2. **跌停股池为0** - `data/history/limit_down/{date}.json` 中的 count 为0
3. **炸板股池为0** - `data/history/explode/{date}.json` 中的 count 为0
4. **文件缺失** - 某个股池的JSON文件不存在
5. **文件损坏** - JSON文件无法正常读取

以上任何一种情况都会将该日期标记为需要重新获取。

## 重新获取流程

当选择重新获取时，脚本会：

1. 显示所有需要重取的日期
2. 逐个日期重新调用智图API获取三个股池数据
3. 覆盖原有的不完整数据文件
4. 显示每个股池的获取结果（成功/失败）
5. 最后输出统计信息（成功天数、失败天数）

**注意：** 重新获取时会使用0.2秒的间隔，避免触发API频率限制。

## 输出示例

```
============================================================
数据完整性检查
============================================================
[2025-08-25] 数据不完整: 炸板为0
  涨停: 77只, 跌停: 2只, 炸板: 0只
[2025-09-17] 数据不完整: 跌停为0
  涨停: 69只, 跌停: 0只, 炸板: 23只
...

============================================================
检查完成!
总检查日期: 152天
数据完整: 145天
需要重取: 7天

需要重新获取的日期: 2025-08-25, 2025-09-17, ...

是否重新获取这些日期的数据? (y/N):
```

## 自动化建议

可以结合定时任务使用：

### Windows任务计划程序

```cmd
# 每天收盘后自动检查并重取不完整数据
python C:\path\to\check_and_refetch.py
```

### Linux/Mac Cron

```bash
# 每天17:30运行
30 17 * * * cd /path/to/lbgpfx && python check_and_refetch.py --check-only >> logs/check.log 2>&1
```

## 注意事项

1. **API限制** - 智图API有频率限制，脚本已内置0.2秒间隔
2. **网络要求** - 需要能够访问 `api.zhituapi.com`
3. **数据覆盖** - 重新获取会覆盖原有文件，请确保有备份（如有需要）
4. **节假日** - 如果某天确实是交易日但没有数据，API可能无法返回（节假日调休等情况）
5. **后续处理** - 重新获取后，建议运行 `generate_ladder_data.py` 更新 `ladder_data.js`

## 集成到工作流

完整的数据更新流程：

```bash
# 1. 获取最近N天数据（首次或补全）
python fetch_history_data.py --days 60

# 2. 检查数据完整性
python check_and_refetch.py

# 3. 重新生成前端数据文件
python generate_ladder_data.py

# 4. 查看网页
start ladder_fixed.html
```

## 故障排除

### 问题：重新获取失败

- 检查网络连接
- 验证API Token是否有效（`fetch_history_data.py` 第18行）
- 查看API响应是否正常（可能是该日期非交易日）

### 问题：某些日期持续失败

- 检查该日期是否为交易日（使用交易日历）
- 手动测试：`python fetch_history_data.py --date 2025-08-25`
- 如果确认为节假日，可以删除该日期的数据文件，避免误报
